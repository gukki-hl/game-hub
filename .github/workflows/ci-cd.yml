name: CI/CD Pipeline

on:
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/game-hub

jobs:
  build-and-deploy:
    name: Build, Push and Monitor
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´çš„ Git å†å²è®°å½•ä»¥æ”¯æŒ Sentry

      # 2. ç”Ÿæˆç‰ˆæœ¬å·
      - name: ğŸ·ï¸ Generate version
        id: version
        run: |
          VERSION="$(date +'%Y.%m.%d')-${GITHUB_SHA::7}"
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Version: ${VERSION}"

      # 3. ç™»å½• Docker Hub
      - name: ğŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 4. æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
      - name: ğŸ³ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:latest
            ${{ env.DOCKER_IMAGE }}:${{ steps.version.outputs.VERSION }}
          build-args: |
            VITE_SENTRY_DSN=${{ secrets.SENTRY_DSN }}
            VITE_APP_VERSION=${{ steps.version.outputs.VERSION }}

      # 5. åˆ›å»º Sentry Releaseï¼ˆç®€åŒ–ç‰ˆï¼‰
      - name: ğŸ¯ Create Sentry Release
        run: |
          # å®‰è£… Sentry CLI
          curl -sL https://sentry.io/get-cli/ | bash

          # åˆ›å»º release
          sentry-cli releases new "${{ github.sha }}"

          # å…³è”æäº¤ï¼ˆè‡ªåŠ¨æ£€æµ‹ï¼‰
          sentry-cli releases set-commits "${{ github.sha }}" --auto --ignore-missing

          # æ ‡è®°ä¸ºå·²éƒ¨ç½²
          sentry-cli releases deploys "${{ github.sha }}" new -e production

          # å®Œæˆ release
          sentry-cli releases finalize "${{ github.sha }}"

          echo "âœ… Sentry Release: ${{ github.sha }}"
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
        continue-on-error: true # Sentry å¤±è´¥ä¸å½±å“æ•´ä½“æµç¨‹

      # 6. æˆåŠŸé€šçŸ¥
      - name: âœ… Deployment Summary
        run: |
          echo "================================================"
          echo "âœ… Deployment Completed Successfully!"
          echo "================================================"
          echo "ğŸ³ Docker Image: ${{ env.DOCKER_IMAGE }}:latest"
          echo "ğŸ“¦ Version: ${{ steps.version.outputs.VERSION }}"
          echo "ğŸ¯ Sentry Release: ${{ github.sha }}"
          echo "ğŸŒ Docker Hub: https://hub.docker.com/r/${{ secrets.DOCKER_USERNAME }}/game-hub"
          echo "================================================"
